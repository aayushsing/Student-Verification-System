<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>JNV Student Verification System</title>

<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<meta name="color-scheme" content="light dark" />

<style>
  :root{
    --brand:#0b4aa2; --brand-2:#062e66;
    --bg:#f5f7fa; --card:#ffffff; --fg:#1d2330; --muted:#687186;
    --radius:16px; --ok:#0b8b4a;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0f141b; --card:#141a22; --fg:#e8eef9; --muted:#94a2b8; }
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--fg)}

  header.appbar{
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
  }
  .left-head{display:flex; align-items:center; gap:12px}
  .logo{
    width:40px;height:40px;border-radius:50%;border:2px solid #fff;
    background:url('jnv.png') center/cover no-repeat
  }
  .titles h1{margin:0;font-size:18px}
  .titles p{margin:2px 0 0;font-size:12px;opacity:.9}
  .dev{display:flex;align-items:center;gap:8px;font-size:12px;background:rgba(255,255,255,.1);padding:6px 10px;border-radius:999px}
  .dev img{
    width:28px;height:28px;border-radius:50%;
    background:url('sankalp.png') center/cover no-repeat;
    border:1px solid rgba(255,255,255,.6)
  }

  main{
    width:100%;max-width:920px;margin:20px auto 90px;
    padding:0 12px;display:grid;gap:16px;grid-template-columns:1fr
  }
  @media(min-width:900px){main{grid-template-columns:1.1fr .9fr}}

  .card{
    background:var(--card);border-radius:var(--radius);
    box-shadow:0 6px 24px rgba(0,0,0,.08);
    border:1px solid rgba(0,0,0,.06)
  }
  .card header{
    padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06);
    display:flex;align-items:center;justify-content:space-between
  }
  .card .content{padding:16px}
  label{font-weight:600;font-size:13px}
  input[type=text], input[type=password], input[type=file]{
    width:100%;padding:10px;border:1px solid #ccd3e0;
    border-radius:10px;font-size:14px;margin:4px 0 10px
  }

  button{
    background:var(--brand);color:#fff;border:0;
    padding:10px 14px;border-radius:10px;
    font-weight:600;cursor:pointer;font-size:14px
  }
  button.secondary{background:#2f3b52}
  button.ghost{background:transparent;color:var(--brand);box-shadow:none}

  .viewer{
    display:none;flex-direction:column;gap:10px;margin-top:10px
  }
  .viewer.active{display:flex;animation:fadeIn .3s ease}
  @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}

  .file-box{
    position:relative;border-top-left-radius:12px;border-top-right-radius:12px;
    border:1px solid #d5dbe7; overflow:hidden; background:#000; height:70vh;
    display:flex; align-items:center; justify-content:center;
  }
  .file-box img, .file-box iframe{
    width:100%; height:100%; border:0; object-fit:contain; background:#fff; transition:opacity .25s ease;
  }

  dialog#lightbox{
    width:100vw;height:100dvh;padding:0;margin:0;border:0;
    background:rgba(0,0,0,.9)
  }
  dialog#lightbox::backdrop{background:rgba(0,0,0,.7)}
  .lb-wrap{
    width:100%;height:100%;display:flex;align-items:center;
    justify-content:center;position:relative
  }
  .lb-media{max-width:96vw;max-height:92vh;object-fit:contain;border-radius:8px;background:#fff}
  .lb-iframe{width:96vw;height:92vh;border:0;border-radius:8px;background:#fff}
  .lb-close{
    position:absolute;top:12px;right:16px;background:#fff;
    border:0;border-radius:999px;padding:8px 12px;
    cursor:pointer;font-weight:700
  }

  .bar{
    position:fixed;bottom:0;left:0;right:0;
    display:flex;justify-content:space-between;align-items:center;
    background:rgba(255,255,255,.7);backdrop-filter:blur(10px);
    padding:10px 14px;font-size:12px;
  }
  .ok{color:var(--ok);font-weight:600}
</style>
</head>
<body>

<header class="appbar">
  <div class="left-head">
    <div class="logo"></div>
    <div class="titles">
      <h1>JNV Student Verification System</h1>
      <p>Secure • Google Drive (jnvschool) • On your device</p>
    </div>
  </div>
  <div class="dev">
    <img src="sankalp.jpg" alt="Sankalp">
    <span>Developed by <b>Sankalp</b></span>
  </div>
</header>

<main>
  <section class="card">
    <header>
      <h2>Upload & Verify</h2>
    </header>
    <div class="content">
      <label>Security PIN</label>
      <input type="password" id="pin" placeholder="Set or enter PIN (min 6 chars)">

      <label>Admission Number</label>
      <input type="text" id="admissionNumber" placeholder="e.g. 2868">

      <label>File Name (optional)</label>
      <input type="text" id="fileName" placeholder="For your reference only">

      <label>Upload Card</label>
      <input type="file" id="fileUpload" accept=".pdf,.xlsx,.xls,image/*">
      <button id="btnUpload">Upload Securely</button>

      <hr>

      <label>Search Admission Number</label>
      <input type="text" id="searchAdmission" placeholder="Enter Admission Number (e.g. 2868)">
      <button class="secondary" id="btnSearch">Search & View</button>

      <div id="viewer" class="viewer">
        <div class="file-box">
          <div id="fileViewer"></div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="ghost" id="btnDownload" style="display:none">Download</button>
          <button class="ghost" id="btnCloseViewer">Close</button>
        </div>
      </div>
    </div>
  </section>
</main>

<nav class="bar">
  <span id="pinState">PIN not set • Connected to jnvschool Drive backend</span>
</nav>

<dialog id="lightbox">
  <div class="lb-wrap">
    <img id="lbImg" class="lb-media" style="display:none" alt="Card">
    <iframe id="lbPdf" class="lb-iframe" style="display:none"></iframe>
    <button class="lb-close" id="lbClose">✕</button>
  </div>
</dialog>

<script>
  // ---------------- CONFIG ----------------
  // IMPORTANT: replace with your Web App URL from Apps Script (must end with /exec)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxr4Bui45R__f3aborQRKSPIiVa6zT83XB02ne7Guz359B6DG73zE1GJHu11ysmY0gnMQ/exec";

  const MAX_BYTES = 25 * 1024 * 1024;
  const ALLOW_MIME = new Set([
    "application/pdf","image/png","image/jpeg","image/webp","image/gif",
    "application/vnd.ms-excel",
    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  ]);
  const EXT_FALLBACK = /\.(pdf|png|jpe?g|webp|gif|xls|xlsx)$/i;

  let currentURL = null;
  let currentFileMeta = null;

  const $ = id => document.getElementById(id);

  // ---------------- UI HELPERS ----------------
  function updatePinState() {
    const ok = $("pin").value.trim().length >= 6;
    $("pinState").textContent =
      (ok ? "PIN ready" : "PIN not set") + " • Connected to jnvschool Drive backend";
  }
  $("pin").addEventListener("input", updatePinState);
  window.addEventListener("DOMContentLoaded", updatePinState);

  function hideViewer(){
    $("viewer").classList.remove("active");
    $("fileViewer").innerHTML = "";
    $("btnDownload").style.display = "none";
    currentURL = null;
    currentFileMeta = null;
  }
  $("btnCloseViewer").addEventListener("click", hideViewer);

  const lb = $("lightbox");
  const lbImg = $("lbImg");
  const lbPdf = $("lbPdf");

  $("lbClose").addEventListener("click", ()=> lb.close());
  lb.addEventListener("click", e => { if(e.target === lb) lb.close(); });

  function openLightbox(type, url){
    if(type === "image"){
      lbPdf.style.display="none";
      lbImg.style.display="block";
      lbImg.src = url;
    } else {
      lbImg.style.display="none";
      lbPdf.style.display="block";
      lbPdf.src = url;
    }
    if(!lb.open) lb.showModal();
  }

  function showFromBackend(meta){
    hideViewer();
    if(meta.error){
      alert(meta.error);
      return;
    }
    currentFileMeta = meta;
    const mime = meta.mimeType || "";
    const previewUrl = meta.previewUrl;
    const downloadUrl = meta.downloadUrl;
    currentURL = previewUrl;

    const viewer = $("fileViewer");
    let el = null;

    if(mime.startsWith("image/")){
      el = document.createElement("img");
      el.alt = "Card";
      el.src = previewUrl;
      el.decoding = "async";
      el.style.width = "100%";
      el.style.height = "100%";
      el.style.objectFit = "contain";
      el.addEventListener("click", ()=> openLightbox("image", previewUrl));
    } else if(mime === "application/pdf") {
      el = document.createElement("iframe");
      el.src = previewUrl;
      el.style.width = "100%";
      el.style.height = "100%";
      el.addEventListener("click", ()=> openLightbox("pdf", previewUrl));
    } else {
      const p = document.createElement("p");
      p.textContent = "This file cannot be previewed. Use Download.";
      viewer.appendChild(p);
    }

    if(el) viewer.appendChild(el);

    $("viewer").classList.add("active");
    const dl = $("btnDownload");
    dl.style.display = "inline-block";
    dl.onclick = () => {
      const a = document.createElement("a");
      a.href = downloadUrl;
      a.download = meta.name || "card";
      document.body.appendChild(a);
      a.click();
      a.remove();
    };

    if(mime.startsWith("image/")) openLightbox("image", previewUrl);
    else if(mime === "application/pdf") openLightbox("pdf", previewUrl);
  }

  // ---------------- UPLOAD HANDLER (POST) ----------------
  $("btnUpload").addEventListener("click", async () => {
    if($("pin").value.trim().length < 6){
      alert("Set a PIN (min 6 chars)");
      return;
    }
    const admission = $("admissionNumber").value.trim();
    const f = $("fileUpload").files[0];
    if(!admission || !f){
      alert("Please fill all fields");
      return;
    }
    if(f.size > MAX_BYTES){
      alert("Max 25MB allowed");
      return;
    }
    const typeOk = ALLOW_MIME.has(f.type) || EXT_FALLBACK.test(f.name);
    if(!typeOk){
      alert("Unsupported file type");
      return;
    }

    try {
      const fd = new FormData();
      fd.append("mode", "upload");        // backend: mode=upload
      fd.append("admission", admission);  // backend: e.parameter.admission
      fd.append("fileName", $("fileName").value.trim() || f.name);
      fd.append("file", f);               // backend: e.files.file

      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: fd
      });

      const text = await res.text();  // raw response
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error("Raw response from server (not JSON):", text);
        alert("Upload failed: server returned invalid response (status " + res.status + ").");
        return;
      }

      if (!res.ok) {
        console.error("Upload HTTP error:", res.status, data);
        alert("Upload failed (HTTP " + res.status + "): " + (data.error || "Unknown error"));
        return;
      }

      if (data.error) {
        alert("Upload failed: " + data.error);
        return;
      }

      alert("File saved to Drive (jnvschool).");
      showFromBackend(data);
    } catch (err) {
      console.error("Upload fetch error:", err);
      alert("Upload failed: " + err.message);
    }
  });

  // ---------------- SEARCH HANDLER (GET) ----------------
  $("btnSearch").addEventListener("click", async () => {
    const admission = $("searchAdmission").value.trim();
    if(!admission){
      alert("Enter an admission number");
      return;
    }

    try {
      // backend: doGet(e) with mode=search & admission=
      const url = SCRIPT_URL + "?mode=search&admission=" + encodeURIComponent(admission);
      const res = await fetch(url);
      const text = await res.text();

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error("Raw response from server (not JSON):", text);
        alert("Search failed: server returned invalid response (status " + res.status + ").");
        return;
      }

      if (!res.ok) {
        console.error("Search HTTP error:", res.status, data);
        alert("Search failed (HTTP " + res.status + "): " + (data.error || "Unknown error"));
        return;
      }

      if (data.error){
        alert(data.error);
        return;
      }

      showFromBackend(data);
    } catch (err) {
      console.error("Search fetch error:", err);
      alert("Search failed: " + err.message);
    }
  });
</script>

</body>
</html>
