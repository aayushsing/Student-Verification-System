<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>JNV Student Verification System</title>

<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<meta name="color-scheme" content="light dark" />

<style>
  :root{
    --brand:#0b4aa2; --brand-2:#062e66;
    --bg:#f5f7fa; --card:#ffffff; --fg:#1d2330; --muted:#687186;
    --radius:16px; --ok:#0b8b4a;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0f141b; --card:#141a22; --fg:#e8eef9; --muted:#94a2b8; }
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--fg)}

  header.appbar{
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
  }
  .left-head{display:flex; align-items:center; gap:12px}
  .logo{width:40px;height:40px;border-radius:50%;border:2px solid #fff;background:url('jnv.png') center/cover no-repeat}
  .titles h1{margin:0;font-size:18px}
  .titles p{margin:2px 0 0;font-size:12px;opacity:.9}
  .dev{display:flex;align-items:center;gap:8px;font-size:12px;background:rgba(255,255,255,.1);padding:6px 10px;border-radius:999px}
  .dev img{width:28px;height:28px;border-radius:50%;background:url('sankalp.png') center/cover no-repeat;border:1px solid rgba(255,255,255,.6)}

  main{width:100%;max-width:920px;margin:20px auto 90px;padding:0 12px;display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:900px){main{grid-template-columns:1.1fr .9fr}}

  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 24px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06)}
  .card header{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
  .card .content{padding:16px}
  label{font-weight:600;font-size:13px}
  input[type=text], input[type=password], input[type=file]{width:100%;padding:10px;border:1px solid #ccd3e0;border-radius:10px;font-size:14px}

  button{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  button.secondary{background:#2f3b52}
  button.ghost{background:transparent;color:var(--brand);box-shadow:none}

  /* Viewer area */
  .viewer{display:none;flex-direction:column;gap:10px;margin-top:10px}
  .viewer.active{display:flex;animation:fadeIn .3s ease}
  @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}

  .file-box{
    position:relative;border-top-left-radius:12px;border-top-right-radius:12px;
    border:1px solid #d5dbe7; overflow:hidden; background:#000; height:70vh;
    display:flex; align-items:center; justify-content:center;
  }
  .file-box img, .file-box iframe{
    width:100%; height:100%; border:0; object-fit:contain; background:#fff; transition:opacity .25s ease;
  }

  /* Lightbox */
  dialog#lightbox{width:100vw;height:100dvh;padding:0;margin:0;border:0;background:rgba(0,0,0,.9)}
  dialog#lightbox::backdrop{background:rgba(0,0,0,.7)}
  .lb-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative}
  .lb-media{max-width:96vw;max-height:92vh;object-fit:contain;border-radius:8px;background:#fff}
  .lb-iframe{width:96vw;height:92vh;border:0;border-radius:8px;background:#fff}
  .lb-close{position:absolute;top:12px;right:16px;background:#fff;border:0;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}

  .bar{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.7);backdrop-filter:blur(10px);padding:10px 14px}
  .ok{color:var(--ok);font-weight:600}
  
  /* Crop Modal (kept but unused, same as your original) */
  #cropModal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    align-items:center;
    justify-content:center;
    z-index:1000;
  }
  #cropBox{
    background:#fff;
    padding:16px;
    border-radius:12px;
    max-width:90vw;
    max-height:90vh;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  #cropImg{
    max-width:100%;
    max-height:70vh;
    object-fit:contain;
  }
  .crop-btns{
    display:flex;
    justify-content:flex-end;
    gap:10px;
  }
</style>
</head>
<body>

<header class="appbar">
  <div class="left-head">
    <div class="logo"></div>
    <div class="titles">
      <h1>JNV Student Verification System</h1>
      <p>Secure • Google Drive • On your device</p>
    </div>
  </div>
  <div class="dev">
    <img src="sankalp.jpg" alt="Sankalp">
    <span>Developed by <b>Sankalp</b></span>
  </div>
</header>

<main>
  <section class="card">
    <header>
      <h2>Upload & Verify</h2>
      <!-- Optional: small sign-in button for Google -->
      <button id="btnSignIn" class="secondary" style="font-size:12px;padding:6px 10px;">Sign in with Google</button>
    </header>
    <div class="content">
      <label>Security PIN</label>
      <input type="password" id="pin" placeholder="Set or enter PIN (min 6 chars)">
      <label>Admission Number</label>
      <input type="text" id="admissionNumber" placeholder="e.g. 2025XXXX">
      <label>File Name (optional)</label>
      <input type="text" id="fileName" placeholder="StudentCard.pdf">
      <label>Upload Card</label>
      <input type="file" id="fileUpload" accept=".pdf,.xlsx,.xls,image/*">
      <button id="btnUpload">Upload Securely</button>

      <hr>

      <label>Search Admission Number</label>
      <input type="text" id="searchAdmission" placeholder="Enter Admission Number">
      <button class="secondary" id="btnSearch">Search & View</button>

      <div id="viewer" class="viewer">
        <div class="file-box">
          <div id="fileViewer"></div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="ghost" id="btnDownload" style="display:none">Download</button>
          <button class="ghost" id="btnCloseViewer">Close</button>
        </div>
      </div>
    </div>
  </section>
</main>

<nav class="bar">
  <span id="pinState">PIN not set • Not signed in</span>
  <!-- Wipe button removed as requested -->
</nav>

<!-- Lightbox -->
<dialog id="lightbox">
  <div class="lb-wrap">
    <img id="lbImg" class="lb-media" style="display:none" alt="Card">
    <iframe id="lbPdf" class="lb-iframe" style="display:none"></iframe>
    <button class="lb-close" id="lbClose">✕</button>
  </div>
</dialog>

<!-- Crop Modal (kept same as original, not wired) -->
<div id="cropModal">
  <div id="cropBox">
    <img id="cropImg" alt="Crop Preview">
    <div class="crop-btns">
      <button id="btnCropSave">Save Crop</button>
      <button class="secondary" id="btnCropCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
// Max upload size
const MAX_BYTES = 25 * 1024 * 1024;

// Supported types
const ALLOW_MIME = new Set([
  "application/pdf","image/png","image/jpeg","image/webp","image/gif",
  "application/vnd.ms-excel",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
]);
const EXT_FALLBACK = /\.(pdf|png|jpe?g|webp|gif|xls|xlsx)$/i;

// TODO: Replace these three values with your real values
const API_KEY        = "AIzaSyDaGqN3VWTmhXfwb0EeEwgT6pgKFUcYURw";
const CLIENT_ID      = "194286766474-gs383hkundid0eiif9s19pca2rcjqk35.apps.googleusercontent.com";
const DRIVE_FOLDER_ID = "https://drive.google.com/drive/folders/1MQnqrZzAyIobaQrrBJOUKYaB5E1Fgp51?usp=sharing"; // All files will be saved here

// Scopes: drive.file is enough for files created by this app
const SCOPES = "https://www.googleapis.com/auth/drive.file";
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

/* ===================== GLOBAL STATE ===================== */
let currentURL = null;          // preview URL
let currentFileMeta = null;     // {id,name,mimeType,webViewLink,webContentLink}
let isSignedIn = false;

const $ = id=>document.getElementById(id);

/* ===================== PIN STATE ===================== */
function updateStatus() {
  const pinOk = $("pin").value.trim().length >= 6;
  $("pinState").textContent =
    (pinOk ? "PIN ready" : "PIN not set") +
    " • " +
    (isSignedIn ? "Signed in to Google Drive" : "Not signed in");
}
$("pin").addEventListener("input", updateStatus);

/* ===================== GOOGLE API INIT ===================== */

function gapiLoaded() {
  gapi.load("client:auth2", initClient);
}

async function initClient() {
  try {
    await gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    });
    const auth = gapi.auth2.getAuthInstance();
    isSignedIn = auth.isSignedIn.get();
    auth.isSignedIn.listen(val => {
      isSignedIn = val;
      updateStatus();
      updateSignInButton();
    });
    updateStatus();
    updateSignInButton();
  } catch (err) {
    console.error("Error initializing GAPI:", err);
    alert("Google Drive API init failed. Check console & keys.");
  }
}

function updateSignInButton() {
  const btn = $("btnSignIn");
  if(!btn) return;
  btn.textContent = isSignedIn ? "Signed in" : "Sign in with Google";
  btn.disabled = false;
}

/* Sign-in button */
$("btnSignIn").addEventListener("click", async () => {
  try {
    const auth = gapi.auth2.getAuthInstance();
    if(!auth) return;
    if(!auth.isSignedIn.get()) {
      await auth.signIn();
    } else {
      alert("Already signed in.");
    }
  } catch (err) {
    console.error(err);
    alert("Sign-in failed.");
  }
});

/* ===================== HELPERS ===================== */

function guessTypeFromName(name){
  if(/\.pdf$/i.test(name)) return "application/pdf";
  if(/\.(png)$/i.test(name)) return "image/png";
  if(/\.(jpe?g)$/i.test(name)) return "image/jpeg";
  if(/\.webp$/i.test(name)) return "image/webp";
  if(/\.gif$/i.test(name)) return "image/gif";
  if(/\.xlsx$/i.test(name)) return "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
  if(/\.xls$/i.test(name)) return "application/vnd.ms-excel";
  return "application/octet-stream";
}

/* Build preview and download URLs from Drive file ID */
function buildPreviewURL(file) {
  // For PDFs & docs: Google viewer
  if(file.mimeType === "application/pdf") {
    return `https://drive.google.com/file/d/${file.id}/preview`;
  }
  // For images: direct view link
  if(file.mimeType.startsWith("image/")) {
    return `https://drive.google.com/uc?export=view&id=${file.id}`;
  }
  // Fallback: viewer
  return `https://drive.google.com/file/d/${file.id}/preview`;
}
function buildDownloadURL(file) {
  // webContentLink often works, but we can ensure with uc?export=download
  return `https://drive.google.com/uc?export=download&id=${file.id}`;
}

/* ===================== UPLOAD TO DRIVE ===================== */

async function uploadToDrive(file, admission, desiredName) {
  if(!isSignedIn) {
    alert("Please sign in with Google first.");
    return null;
  }

  const fileName = desiredName || file.name;
  const fullName = `${admission}_${fileName}`; // include admission no in name

  // Build multipart request body
  const boundary = "-------314159265358979323846";
  const delimiter = "\r\n--" + boundary + "\r\n";
  const closeDelim = "\r\n--" + boundary + "--";

  const metadata = {
    name: fullName,
    parents: [DRIVE_FOLDER_ID],
    description: `JNV card for admission ${admission}`
  };

  const contentType = file.type || guessTypeFromName(fileName);

  const base64Data = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const data = btoa(e.target.result);
      resolve(data);
    };
    reader.onerror = reject;
    reader.readAsBinaryString(file);
  });

  const multipartRequestBody =
    delimiter +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    JSON.stringify(metadata) +
    delimiter +
    "Content-Type: " + contentType + "\r\n" +
    "Content-Transfer-Encoding: base64\r\n\r\n" +
    base64Data +
    closeDelim;

  const uploadRes = await gapi.client.request({
    path: "/upload/drive/v3/files",
    method: "POST",
    params: { uploadType: "multipart" },
    headers: {
      "Content-Type": 'multipart/related; boundary="' + boundary + '"'
    },
    body: multipartRequestBody
  });

  const fileId = uploadRes.result.id;

  // Make file public viewable (anyone with link)
  await gapi.client.drive.permissions.create({
    fileId,
    resource: {
      role: "reader",
      type: "anyone"
    }
  });

  // Fetch final metadata including web links
  const fileRes = await gapi.client.drive.files.get({
    fileId,
    fields: "id,name,mimeType,webViewLink,webContentLink"
  });

  return fileRes.result;
}

/* ===================== SEARCH IN DRIVE BY ADMISSION ===================== */

async function searchFileByAdmission(admission) {
  if(!isSignedIn) {
    alert("Please sign in with Google first.");
    return null;
  }

  // We stored name as "admission_fileName"
  const q = [
    `'${DRIVE_FOLDER_ID}' in parents`,
    "trashed=false",
    `name contains '${admission}'`
  ].join(" and ");

  const res = await gapi.client.drive.files.list({
    q,
    pageSize: 1,
    fields: "files(id,name,mimeType,webViewLink,webContentLink)"
  });

  if(!res.result.files || !res.result.files.length) {
    return null;
  }
  return res.result.files[0];
}

/* ===================== VIEWER / LIGHTBOX ===================== */

function hideViewer(){
  $("viewer").classList.remove("active");
  $("fileViewer").innerHTML = "";
  $("btnDownload").style.display = "none";
  if(currentURL){ currentURL=null; }
  currentFileMeta = null;
}

$("btnCloseViewer").addEventListener("click", hideViewer);

const lb = $("lightbox");
const lbImg = $("lbImg");
const lbPdf = $("lbPdf");

$("lbClose").addEventListener("click", ()=> lb.close());
lb.addEventListener("click", e=>{ if(e.target===lb) lb.close(); });

function openLightbox(type, url){
  if(type === "image"){
    lbPdf.style.display="none";
    lbImg.style.display="block";
    lbImg.src = url;
  }else{
    lbImg.style.display="none";
    lbPdf.style.display="block";
    lbPdf.src = url;
  }
  if(!lb.open) lb.showModal();
}

function showDriveFile(file){
  hideViewer(); // reset first

  currentFileMeta = file;

  const mime = file.mimeType || guessTypeFromName(file.name);
  const previewUrl = buildPreviewURL(file);
  const downloadUrl = buildDownloadURL(file);
  currentURL = previewUrl;

  const viewer = $("fileViewer");
  let el;

  if(mime.startsWith("image/")){
    el = document.createElement("img");
    el.alt = "Card";
    el.src = previewUrl;
    el.decoding = "async";
    el.style.width = "100%";
    el.style.height = "100%";
    el.style.objectFit = "contain";
    el.addEventListener("click", ()=> openLightbox("image", previewUrl));
  } else if(mime === "application/pdf") {
    el = document.createElement("iframe");
    el.src = previewUrl;
    el.style.width = "100%";
    el.style.height = "100%";
    el.addEventListener("click", ()=> openLightbox("pdf", previewUrl));
  } else {
    const p = document.createElement("p");
    p.textContent = "This file cannot be previewed. Use Download.";
    viewer.appendChild(p);
  }

  if(el) viewer.appendChild(el);

  $("viewer").classList.add("active");
  const dl = $("btnDownload");
  dl.style.display = "inline-block";
  dl.onclick = ()=> {
    const a = document.createElement("a");
    a.href = downloadUrl;
    a.download = file.name || "card";
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  // Auto-open lightbox
  if(mime.startsWith("image/")) openLightbox("image", previewUrl);
  else if(mime === "application/pdf") openLightbox("pdf", previewUrl);
}

/* ===================== BUTTON HANDLERS ===================== */

// Upload button
$("btnUpload").addEventListener("click", async ()=>{
  if($("pin").value.trim().length<6) {
    alert("Set a PIN (min 6 chars)");
    return;
  }

  const admission = $("admissionNumber").value.trim();
  const f = $("fileUpload").files[0];

  if(!admission || !f) {
    alert("Please fill all fields");
    return;
  }
  if(f.size > MAX_BYTES) {
    alert("Max 25MB allowed");
    return;
  }
  const typeOk = ALLOW_MIME.has(f.type) || EXT_FALLBACK.test(f.name);
  if(!typeOk) {
    alert("Unsupported file type");
    return;
  }

  try {
    const result = await uploadToDrive(
      f,
      admission,
      $("fileName").value.trim() || f.name
    );
    if(result) {
      alert("File saved to Google Drive and made public.");
    }
  } catch (err) {
    console.error("Upload error:", err);
    alert("Upload failed. Check console.");
  }
});

// Search button
$("btnSearch").addEventListener("click", async ()=>{
  const id = $("searchAdmission").value.trim();
  if(!id) {
    alert("Enter an admission number");
    return;
  }
  try {
    const file = await searchFileByAdmission(id);
    if(!file) {
      alert("No card found in Drive for this admission number.");
      return;
    }
    showDriveFile(file);
  } catch (err) {
    console.error("Search error:", err);
    alert("Search failed. Check console.");
  }
});

// Initial status
updateStatus();
</script>

<!-- Load Google API JS (must be after the script above so gapiLoaded exists) -->
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

</body>
</html>

