<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>JNV Student Verification System</title>

<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<meta name="color-scheme" content="light dark" />

<style>
  :root{
    --brand:#0b4aa2; --brand-2:#062e66;
    --bg:#f5f7fa; --card:#ffffff; --fg:#1d2330; --muted:#687186;
    --radius:16px; --ok:#0b8b4a;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0f141b; --card:#141a22; --fg:#e8eef9; --muted:#94a2b8; }
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--fg)}

  header.appbar{
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
  }
  .left-head{display:flex; align-items:center; gap:12px}
  .logo{width:40px;height:40px;border-radius:50%;border:2px solid #fff;background:url('jnv.png') center/cover no-repeat}
  .titles h1{margin:0;font-size:18px}
  .titles p{margin:2px 0 0;font-size:12px;opacity:.9}
  .dev{display:flex;align-items:center;gap:8px;font-size:12px;background:rgba(255,255,255,.1);padding:6px 10px;border-radius:999px}
  .dev img{width:28px;height:28px;border-radius:50%;background:url('sankalp.png') center/cover no-repeat;border:1px solid rgba(255,255,255,.6)}

  main{width:100%;max-width:920px;margin:20px auto 90px;padding:0 12px;display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:900px){main{grid-template-columns:1.1fr .9fr}}

  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 24px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06)}
  .card header{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between}
  .card .content{padding:16px}
  label{font-weight:600;font-size:13px}
  input[type=text], input[type=password], input[type=file]{width:100%;padding:10px;border:1px solid #ccd3e0;border-radius:10px;font-size:14px}

  button{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  button.secondary{background:#2f3b52}
  button.ghost{background:transparent;color:var(--brand);box-shadow:none}

  /* Viewer area */
  .viewer{display:none;flex-direction:column;gap:10px;margin-top:10px}
  .viewer.active{display:flex;animation:fadeIn .3s ease}
  @keyframes fadeIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}

  .file-box{
    position:relative;border-top-left-radius:12px;border-top-right-radius:12px;
    border:1px solid #d5dbe7; overflow:hidden; background:#000; height:70vh;
    display:flex; align-items:center; justify-content:center;
  }
  .file-box img, .file-box iframe{
    width:100%; height:100%; border:0; object-fit:contain; background:#fff; transition:opacity .25s ease;
  }

  /* Lightbox */
  dialog#lightbox{width:100vw;height:100dvh;padding:0;margin:0;border:0;background:rgba(0,0,0,.9)}
  dialog#lightbox::backdrop{background:rgba(0,0,0,.7)}
  .lb-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative}
  .lb-media{max-width:96vw;max-height:92vh;object-fit:contain;border-radius:8px;background:#fff}
  .lb-iframe{width:96vw;height:92vh;border:0;border-radius:8px;background:#fff}
  .lb-close{position:absolute;top:12px;right:16px;background:#fff;border:0;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}

  .bar{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.7);backdrop-filter:blur(10px);padding:10px 14px}
  .ok{color:var(--ok);font-weight:600}
</style>
</head>
<body>

<header class="appbar">
  <div class="left-head">
    <div class="logo"></div>
    <div class="titles">
      <h1>JNV Student Verification System</h1>
      <p>Secure • Offline • On your device</p>
    </div>
  </div>
  <div class="dev">
    <img src="sankalp.png" alt="Sankalp">
    <span>Developed by <b>Sankalp</b></span>
  </div>
</header>

<main>
  <section class="card">
    <header><h2>Upload & Verify</h2></header>
    <div class="content">
      <label>Security PIN</label>
      <input type="password" id="pin" placeholder="Set or enter PIN (min 6 chars)">
      <label>Admission Number</label>
      <input type="text" id="admissionNumber" placeholder="e.g. 2025XXXX">
      <label>File Name (optional)</label>
      <input type="text" id="fileName" placeholder="StudentCard.pdf">
      <label>Upload Card</label>
      <input type="file" id="fileUpload" accept=".pdf,.xlsx,.xls,image/*">
      <button id="btnUpload">Upload Securely</button>

      <hr>

      <label>Search Admission Number</label>
      <input type="text" id="searchAdmission" placeholder="Enter Admission Number">
      <button class="secondary" id="btnSearch">Search & View</button>

      <div id="viewer" class="viewer">
        <div class="file-box">
          <div id="fileViewer"></div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="ghost" id="btnDownload" style="display:none">Download</button>
          <button class="ghost" id="btnCloseViewer">Close</button>
        </div>
      </div>
    </div>
  </section>
</main>

<nav class="bar">
  <span id="pinState">PIN not set</span>
  <button id="btnWipe" class="secondary">Wipe All</button>
</nav>

<!-- Lightbox -->
<dialog id="lightbox">
  <div class="lb-wrap">
    <img id="lbImg" class="lb-media" style="display:none" alt="Card">
    <!-- IMPORTANT: allow-scripts + allow-same-origin so PDF viewer can run -->
    <iframe id="lbPdf" class="lb-iframe" style="display:none" sandbox="allow-scripts allow-same-origin allow-downloads"></iframe>
    <button class="lb-close" id="lbClose">✕</button>
  </div>
</dialog>

<script>
/* Config */
const MAX_BYTES = 25 * 1024 * 1024;
const ALLOW_MIME = new Set([
  "application/pdf","image/png","image/jpeg","image/webp","image/gif",
  "application/vnd.ms-excel",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
]);
const EXT_FALLBACK = /\.(pdf|png|jpe?g|webp|gif|xls|xlsx)$/i;

/* Simple (unencrypted) local DB for reliability; can switch to encrypted later */
let db, currentKey=null, currentURL=null;
const $ = id=>document.getElementById(id);

/* DB init */
const openReq = indexedDB.open("JNVSecureDB", 1);
openReq.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains("cards")){
    db.createObjectStore("cards",{keyPath:"admission"});
  }
};
openReq.onsuccess = e => { db = e.target.result; };
openReq.onerror = ()=> alert("Database error");

/* PIN (placeholder for future encryption hook) */
function setPinState(ok){ $("pinState").textContent = ok ? "PIN ready" : "PIN not set"; }
$("pin").addEventListener("input", e => setPinState(e.target.value.trim().length>=6));

/* Upload */
$("btnUpload").addEventListener("click", async ()=>{
  if($("pin").value.trim().length<6) return alert("Set a PIN (min 6 chars)");
  const admission = $("admissionNumber").value.trim();
  const f = $("fileUpload").files[0];
  if(!admission || !f) return alert("Please fill all fields");
  if(f.size > MAX_BYTES) return alert("Max 25MB allowed");
  const typeOk = ALLOW_MIME.has(f.type) || EXT_FALLBACK.test(f.name);
  if(!typeOk) return alert("Unsupported file type");

  const buf = await f.arrayBuffer();
  const rec = {
    admission,
    fileName: $("fileName").value.trim() || f.name,
    type: f.type || guessTypeFromName(f.name),
    data: new Blob([buf], {type: f.type || guessTypeFromName(f.name)}),
    ts: Date.now()
  };
  const tx = db.transaction("cards","readwrite");
  tx.objectStore("cards").put(rec);
  tx.oncomplete = ()=> alert("Saved locally");
});

/* Search & view */
$("btnSearch").addEventListener("click", ()=>{
  const id = $("searchAdmission").value.trim();
  if(!id) return alert("Enter an admission number");
  const tx = db.transaction("cards","readonly");
  tx.objectStore("cards").get(id).onsuccess = e=>{
    const rec = e.target.result;
    if(!rec) return alert("No card found");
    showRecord(rec);
  };
});
$("btnCloseViewer").addEventListener("click", hideViewer);

function hideViewer(){
  $("viewer").classList.remove("active");
  $("fileViewer").innerHTML = "";
  $("btnDownload").style.display = "none";
  if(currentURL){ URL.revokeObjectURL(currentURL); currentURL=null; }
}

function guessTypeFromName(name){
  if(/\.pdf$/i.test(name)) return "application/pdf";
  if(/\.(png)$/i.test(name)) return "image/png";
  if(/\.(jpe?g)$/i.test(name)) return "image/jpeg";
  if(/\.webp$/i.test(name)) return "image/webp";
  if(/\.gif$/i.test(name)) return "image/gif";
  if(/\.xlsx$/i.test(name)) return "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
  if(/\.xls$/i.test(name)) return "application/vnd.ms-excel";
  return "application/octet-stream";
}

function showRecord(r){
  hideViewer(); // reset first
  const blob = r.data instanceof Blob ? r.data : new Blob([r.data], {type:r.type});
  const mime = r.type || blob.type || guessTypeFromName(r.fileName);
  const url = URL.createObjectURL(blob);
  currentURL = url;

  const viewer = $("fileViewer");
  let el;

  if(mime.startsWith("image/")){
    el = document.createElement("img");
    el.alt = "Card";
    el.src = url;
    el.decoding = "async";
    el.style.width = "100%";
    el.style.height = "100%";
    el.style.objectFit = "contain";
    el.addEventListener("click", ()=> openLightbox("image", url));
  }else if(mime === "application/pdf"){
    el = document.createElement("iframe");
    // IMPORTANT: allow scripts + same-origin so Chrome PDF viewer can render
    el.setAttribute("sandbox","allow-scripts allow-same-origin allow-downloads");
    el.src = url + "#view=FitH"; // hint to fit horizontally
    el.style.width = "100%";
    el.style.height = "100%";
    el.addEventListener("click", ()=> openLightbox("pdf", url));
  }else{
    const p = document.createElement("p");
    p.textContent = "This file cannot be previewed. Use Download.";
    viewer.appendChild(p);
  }

  if(el) viewer.appendChild(el);

  $("viewer").classList.add("active");
  const dl = $("btnDownload");
  dl.style.display = "inline-block";
  dl.onclick = ()=>{
    const a = document.createElement("a");
    a.href = url; a.download = r.fileName || "card"; document.body.appendChild(a);
    a.click(); a.remove();
  };

  // Auto-open lightbox immediately (fits screen)
  if(mime.startsWith("image/")) openLightbox("image", url);
  else if(mime === "application/pdf") openLightbox("pdf", url);
}

/* Lightbox */
const lb = $("lightbox");
const lbImg = $("lbImg");
const lbPdf = $("lbPdf");
$("lbClose").addEventListener("click", ()=> lb.close());
lb.addEventListener("click", e=>{ if(e.target===lb) lb.close(); });

function openLightbox(type, url){
  if(type === "image"){
    lbPdf.style.display="none";
    lbImg.style.display="block";
    lbImg.src = url;
  }else{
    lbImg.style.display="none";
    lbPdf.style.display="block";
    // Keep same sandbox flags here too
    lbPdf.setAttribute("sandbox","allow-scripts allow-same-origin allow-downloads");
    lbPdf.src = url + "#view=FitH";
  }
  if(!lb.open) lb.showModal();
}

/* Wipe all */
$("btnWipe").addEventListener("click", ()=>{
  if(confirm("Delete all records on this device?")){
    const tx = db.transaction("cards","readwrite");
    tx.objectStore("cards").clear();
    tx.oncomplete = ()=> { hideViewer(); alert("Cleared"); };
  }
});
</script>

</body>
</html>
